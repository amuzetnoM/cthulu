<div class="h-screen w-screen bg-herald-black flex flex-col p-4 gap-4 font-sans text-herald-text overflow-hidden relative">
  
  <!-- Header -->
  <header class="flex justify-between items-center pb-4 border-b border-herald-dim/20 shrink-0">
    <div class="flex items-center gap-4">
      <h1 class="text-2xl font-bold tracking-tighter text-white">
        CTHULU <span class="text-herald-accent font-mono text-sm font-normal">v2.4.1</span>
      </h1>
      <div class="h-6 w-px bg-herald-dim/50"></div>
      <span class="text-xs text-herald-text/50 uppercase tracking-widest">Autonomous Adaptive Trading</span>
    </div>
    
    <div class="flex items-center gap-3">
      <button 
        (click)="toggleOrderBook()"
        class="px-3 py-1.5 rounded border border-herald-dim/30 text-xs font-mono font-bold transition-colors hover:bg-white/5 text-herald-text/70 hover:text-white flex items-center gap-2"
        [class.bg-herald-panel]="showOrderBook()"
        [class.text-herald-accent]="showOrderBook()"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
        ORDER BOOK
      </button>

      <button 
        (click)="toggleSystem()"
        class="px-4 py-1.5 rounded border text-xs font-mono font-bold transition-colors hover:bg-white/5"
        [class.border-herald-accent]="isRunning()"
        [class.text-herald-accent]="isRunning()"
        [class.border-herald-danger]="!isRunning()"
        [class.text-herald-danger]="!isRunning()"
      >
        {{ isRunning() ? 'STOP AUTO' : 'START AUTO' }}
      </button>
    </div>
  </header>

  <!-- Top Stats -->
  <section class="shrink-0">
    <app-stats-ticker
      [price]="currentPrice()"
      [pnl]="pnl()"
      [openPositions]="openPositions()"
      [running]="isRunning()"
    ></app-stats-ticker>
  </section>

  <!-- Main Grid -->
  <div class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-4 min-h-0 relative z-0">
    
    <!-- Left Column: Chart & Trades (8 cols) -->
    <div class="lg:col-span-8 flex flex-col gap-4 min-h-0">
      
      <!-- Chart Area -->
      <div class="flex-1 min-h-[300px] bg-herald-panel rounded-lg border border-herald-dim/30 p-1 relative group">
        <div class="absolute top-4 left-4 z-10 flex gap-2">
           <span class="px-2 py-1 bg-black/50 backdrop-blur text-[10px] font-mono rounded text-herald-text/70 border border-herald-dim/30">BTC/USD</span>
           <span class="px-2 py-1 bg-black/50 backdrop-blur text-[10px] font-mono rounded text-herald-text/70 border border-herald-dim/30">1S</span>
           
           <!-- Legend -->
           <div class="flex items-center gap-1 px-2 py-1 bg-black/50 backdrop-blur text-[10px] font-mono rounded border border-herald-dim/30">
              <span class="w-2 h-2 rounded-full bg-herald-accent"></span>
              <span class="text-herald-text/70">PRICE</span>
           </div>
           <div class="flex items-center gap-1 px-2 py-1 bg-black/50 backdrop-blur text-[10px] font-mono rounded border border-herald-dim/30">
              <span class="w-2 h-0.5 bg-[#ffbf00]"></span>
              <span class="text-herald-text/70">SMA(20)</span>
           </div>
           
           <!-- Live RSI Indicator -->
           <div class="flex items-center gap-2 px-2 py-1 bg-black/50 backdrop-blur text-[10px] font-mono rounded border border-herald-dim/30">
              <span class="text-herald-text/50">RSI(14):</span>
              <span class="font-bold" [class.text-herald-accent]="currentRSI() < 30" [class.text-herald-danger]="currentRSI() > 70">
                {{ currentRSI() | number:'1.1-1' }}
              </span>
           </div>
        </div>
        <app-market-chart [data]="priceHistory()" [trades]="trades()"></app-market-chart>
      </div>

      <!-- Active Trades Table -->
      <div class="h-1/3 bg-herald-panel rounded-lg border border-herald-dim/30 overflow-hidden flex flex-col">
        <div class="px-3 py-2 border-b border-herald-dim/30 bg-herald-black/20 flex justify-between items-center">
          <span class="text-xs font-semibold text-herald-text/70">ACTIVE POSITIONS</span>
        </div>
        <div class="overflow-y-auto flex-1 p-0">
          <table class="w-full text-left border-collapse">
            <thead class="bg-herald-black text-[10px] text-herald-text/40 font-mono sticky top-0 z-20">
              <tr>
                <th class="p-2 font-normal">ID</th>
                <th class="p-2 font-normal">TYPE</th>
                <th class="p-2 font-normal text-right">SIZE</th>
                <th class="p-2 font-normal text-right">ENTRY</th>
                <th class="p-2 font-normal text-right">PNL</th>
                <th class="p-2 font-normal">STRATEGY</th>
                <th class="p-2 font-normal"></th>
              </tr>
            </thead>
            <tbody class="text-xs font-mono">
              @for (trade of trades(); track trade.id) {
                @if (trade.status === 'OPEN') {
                  <tr class="border-b border-herald-dim/10 hover:bg-white/5 transition-colors">
                    <td class="p-2 text-herald-text/50">#{{ trade.id }}</td>
                    <td class="p-2 font-bold" [class.text-herald-accent]="trade.type === 'BUY'" [class.text-herald-danger]="trade.type === 'SELL'">
                      {{ trade.type }}
                    </td>
                    <td class="p-2 text-right">{{ trade.size }}</td>
                    <td class="p-2 text-right text-herald-text/70">{{ trade.price | number:'1.2-2' }}</td>
                    <td class="p-2 text-right" [class.text-herald-accent]="(trade.pnl || 0) >= 0" [class.text-herald-danger]="(trade.pnl || 0) < 0">
                      {{ (trade.pnl || 0) | number:'1.2-2' }}
                    </td>
                    <td class="p-2 text-herald-text/60 truncate max-w-[150px]" title="{{ trade.reason }}">
                       {{ trade.reason || trade.origin }}
                    </td>
                    <td class="p-2 text-right">
                       <button (click)="closePosition(trade.id)" class="text-[10px] text-herald-text/40 hover:text-white underline">CLOSE</button>
                    </td>
                  </tr>
                }
              }
              @if (openPositions() === 0) {
                 <tr>
                    <td colspan="7" class="p-8 text-center text-herald-text/20 italic">No active positions</td>
                 </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Right Column: Terminal Only (4 cols) -->
    <div class="lg:col-span-4 flex flex-col gap-4 min-h-0">
      <app-terminal [logs]="logs()" class="flex-1"></app-terminal>
    </div>
  </div>

  <!-- Order Book Drawer -->
  <div 
    class="fixed inset-y-0 right-0 w-80 bg-herald-panel border-l border-herald-dim/30 shadow-2xl z-50 transform transition-transform duration-300 ease-in-out flex flex-col"
    [class.translate-x-full]="!showOrderBook()"
    [class.translate-x-0]="showOrderBook()"
  >
    <div class="p-4 border-b border-herald-dim/20 flex justify-between items-center bg-herald-black/20">
       <span class="text-sm font-bold text-white tracking-wider">DEPTH OF MARKET</span>
       <button (click)="toggleOrderBook()" class="text-herald-text/50 hover:text-white transition-colors">
         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
       </button>
    </div>
    <div class="flex-1 overflow-hidden p-4">
      <app-order-book [book]="orderBook()"></app-order-book>
    </div>
  </div>

  <!-- Overlay for Mobile/Focus -->
  @if (showOrderBook()) {
    <div (click)="toggleOrderBook()" class="fixed inset-0 bg-black/50 z-40 backdrop-blur-sm lg:hidden"></div>
  }

</div>