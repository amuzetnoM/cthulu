<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APEX ARCH</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-purple: #9b59b6;
            --accent-blue: #3498db;
            --accent-green: #27ae60;
            --accent-orange: #f39c12;
            --accent-red: #e74c3c;
            --accent-cyan: #00d4ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 2rem;
        }

        h1,
        h2,
        h3 {
            margin-bottom: 1rem;
        }

        h1 {
            color: var(--accent-purple);
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .version-badge {
            text-align: center;
            margin-bottom: 2rem;
        }

        .version-badge span {
            background: linear-gradient(135deg, #4B0082, #6A00FF);
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .last-updated {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }

        .section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #30363d;
        }

        .section h2 {
            color: var(--accent-cyan);
            border-bottom: 2px solid var(--accent-cyan);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .mermaid {
            background: #1c2128;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .color-cognition {
            background: #9b59b6;
        }

        .color-risk {
            background: #e74c3c;
        }

        .color-exit {
            background: #f39c12;
        }

        .color-execution {
            background: #27ae60;
        }

        .color-strategy {
            background: #3498db;
        }

        .color-entry {
            background: #00d4ff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th,
        td {
            padding: 0.75rem;
            text-align: left;
            border: 1px solid #30363d;
        }

        th {
            background: #21262d;
            color: var(--accent-cyan);
        }

        tr:nth-child(even) {
            background: #1c2128;
        }

        .status-operational {
            color: #27ae60;
        }

        .status-new {
            color: #00d4ff;
        }

        .status-enhanced {
            color: #f39c12;
        }

        code {
            background: #21262d;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
        }

        .flow-description {
            background: #1c2128;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid var(--accent-purple);
        }

        .critical-note {
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid var(--accent-red);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        .new-feature {
            background: rgba(0, 212, 255, 0.1);
            border-left: 4px solid var(--accent-cyan);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        pre {
            background: #1c2128;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>üëæ</h1>
    <div class="version-badge"><span>v5.1.0 RULE-BASED</span></div>
    <div class="last-updated">Last Updated: 2026-01-09 | Comprehensive Architecture Map ‚Äî Post-Stabilization</div>

    <!-- Main Architecture -->
    <div class="section">
        <h2>üèóÔ∏è Complete System Architecture</h2>
        <div class="mermaid">
            flowchart TB
            subgraph ENTRY["Entry Layer"]
            MAIN["__main__.py"]
            WIZ["wizard.py"]
            CLI["CLI Args"]
            end

            subgraph CORE["Core Engine"]
            BOOT["bootstrap.py&lt;br/&gt;System Init"]
            LOOP["trading_loop.py&lt;br/&gt;Main Loop"]
            SHUT["shutdown.py"]
            end

            subgraph COGNITION["Cognition Engine ‚Äî Rule-Based"]
            COG_ENG["Pattern Analysis"]
            REGIME["regime_classifier.py"]
            CANDLE["candlestick_patterns.py"]
            SR["support_resistance.py"]
            VOL_PROF["volume_profile.py"]
            SESSION["session_analysis.py"]
            ENTRY_CONF["entry_confluence.py&lt;br/&gt;Quality Gate"]
            end

            subgraph STRATEGY["Strategy Layer ‚Äî 7 Strategies"]
            SEL["strategy_selector.py"]
            STRATS["SMA|EMA|Momentum&lt;br/&gt;Scalping|Trend|MeanRev|RSI"]
            end

            subgraph RISK["Risk Management"]
            EVAL["evaluator.py"]
            ADAPT["adaptive_*"]
            DYN["dynamic_sltp.py"]
            end

            subgraph EXIT["Exit System"]
            COORD["coordinator.py"]
            TRAIL["trailing_stop.py"]
            EXITS["time|profit|adverse"]
            end

            subgraph POSITION["Position Management"]
            TM["trade_manager.py"]
            ADOPT["adoption.py"]
            LIFE["lifecycle.py"]
            end

            subgraph EXECUTION["Execution"]
            ENGINE["engine.py"]
            MT5["mt5_connector.py"]
            end

            ENTRY --> CORE
            CORE --> COGNITION
            CORE --> STRATEGY
            COGNITION -.-> STRATEGY
            LOOP --> RISK
            RISK --> POSITION
            POSITION --> EXIT
            EXIT --> EXECUTION
            EXECUTION --> MT5
            ENTRY_CONF -.->|quality gate| EXECUTION

            style COGNITION fill:#9b59b6,stroke:#8e44ad,color:#fff
            style RISK fill:#e74c3c,stroke:#c0392b,color:#fff
            style EXIT fill:#f39c12,stroke:#d68910,color:#fff
            style EXECUTION fill:#27ae60,stroke:#1e8449,color:#fff
            style STRATEGY fill:#3498db,stroke:#2980b9,color:#fff
            style ENTRY_CONF fill:#00d4ff,stroke:#00a8cc,color:#000
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color color-cognition"></div> Cognition/AI Layer
            </div>
            <div class="legend-item">
                <div class="legend-color color-risk"></div> Risk Management
            </div>
            <div class="legend-item">
                <div class="legend-color color-exit"></div> Exit System
            </div>
            <div class="legend-item">
                <div class="legend-color color-execution"></div> Execution Engine
            </div>
            <div class="legend-item">
                <div class="legend-color color-strategy"></div> Strategy Layer
            </div>
            <div class="legend-item">
                <div class="legend-color color-entry"></div> Entry Confluence (NEW)
            </div>
        </div>
    </div>

    <!-- Signal Flow -->
    <div class="section">
        <h2>üì° Signal-to-Execution Flow</h2>
        <div class="new-feature">
            <strong>üÜï Entry Confluence Filter:</strong> Quality gate that analyzes entry timing, price levels,
            and momentum alignment BEFORE execution. Prevents blind entries that turn winning signals into losers.
        </div>
        <div class="mermaid">
            flowchart LR
            S1["Strategy Signal"] --> S2["Cognition Enhancement"]
            S2 --> Q1["Entry Confluence&lt;br/&gt;Filter"]
            Q1 --> Q2{"Quality?"}
            Q2 -->|PREMIUM/GOOD| R1["Risk Approval"]
            Q2 -->|MARGINAL| R2["Reduced Size"]
            Q2 -->|POOR| Q3["Queue for Better"]
            Q2 -->|REJECT| X["‚ùå Rejected"]
            R1 --> E1["Execute"]
            R2 --> E1
            Q3 -.->|price reached| Q1

            style Q1 fill:#00d4ff,stroke:#00a8cc,color:#000
            style X fill:#e74c3c,stroke:#c0392b,color:#fff
        </div>

        <div class="flow-description">
            <h3>Entry Confluence Scoring:</h3>
            <ul>
                <li><strong>Level Score (40%):</strong> S/R, round numbers, EMAs, previous session levels</li>
                <li><strong>Momentum Score (25%):</strong> Bar momentum, RSI confirmation</li>
                <li><strong>Timing Score (20%):</strong> Range position, extension from levels</li>
                <li><strong>Structure Score (15%):</strong> Higher highs/lows alignment</li>
            </ul>
        </div>
    </div>

    <!-- Exit Flow -->
    <div class="section">
        <h2>üö™ Exit Decision Flow</h2>
        <div class="mermaid">
            flowchart TB
            P["Position"] --> EVAL["Exit Strategies"]
            EVAL --> C["Confluence Exit&lt;br/&gt;Analysis"]
            C --> D{"Score?"}
            D -->|&lt; 0.55| HOLD["HOLD"]
            D -->|0.55-0.74| SCALE["SCALE_OUT"]
            D -->|0.75-0.89| CLOSE["CLOSE_NOW"]
            D -->|&gt;= 0.90| EMERG["EMERGENCY"]
            SCALE --> X["Execute Exit"]
            CLOSE --> X
            EMERG --> X

            style C fill:#f39c12,stroke:#d68910,color:#000
            style EMERG fill:#e74c3c,stroke:#c0392b,color:#fff
        </div>
    </div>

    <!-- Module Matrix -->
    <div class="section">
        <h2>üìÅ Complete Module Matrix</h2>
        <table>
            <thead>
                <tr>
                    <th>Layer</th>
                    <th>Module</th>
                    <th>File</th>
                    <th>Purpose</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <!-- Core -->
                <tr>
                    <td rowspan="4">‚öôÔ∏è Core</td>
                    <td>Bootstrap</td>
                    <td><code>core/bootstrap.py</code></td>
                    <td>System initialization, component wiring</td>
                    <td class="status-operational">‚úÖ STABLE</td>
                </tr>
                <tr>
                    <td>Trading Loop</td>
                    <td><code>core/trading_loop.py</code></td>
                    <td>Main loop, signal‚Üíexecution pipeline</td>
                    <td class="status-operational">‚úÖ STABLE</td>
                </tr>
                <tr>
                    <td>Shutdown</td>
                    <td><code>core/shutdown.py</code></td>
                    <td>Graceful shutdown, A/S/N prompt</td>
                    <td class="status-operational">‚úÖ STABLE</td>
                </tr>
                <tr>
                    <td>Strategy Factory</td>
                    <td><code>core/strategy_factory.py</code></td>
                    <td>Strategy instantiation</td>
                    <td class="status-operational">‚úÖ STABLE</td>
                </tr>
                <!-- Cognition -->
                <tr>
                    <td rowspan="5">üß† Cognition</td>
                    <td>Entry Confluence</td>
                    <td><code>cognition/entry_confluence.py</code></td>
                    <td>Quality gate for trade entries</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>Candlestick Patterns</td>
                    <td><code>cognition/analysis/candlestick_patterns.py</code></td>
                    <td>Pattern recognition (doji, engulfing, etc)</td>
                    <td class="status-new">üÜï NEW</td>
                </tr>
                <tr>
                    <td>Support/Resistance</td>
                    <td><code>cognition/analysis/support_resistance.py</code></td>
                    <td>S/R zones, pivots, fractals</td>
                    <td class="status-new">üÜï NEW</td>
                </tr>
                <tr>
                    <td>Volume Profile</td>
                    <td><code>cognition/analysis/volume_profile.py</code></td>
                    <td>VPVR, POC, VAH/VAL</td>
                    <td class="status-new">üÜï NEW</td>
                </tr>
                <tr>
                    <td>Session Analysis</td>
                    <td><code>cognition/analysis/session_based.py</code></td>
                    <td>ORB, session detection</td>
                    <td class="status-new">üÜï NEW</td>
                </tr>
                <!-- Strategy -->
                <tr>
                    <td rowspan="8">üìä Strategy</td>
                    <td>Strategy Selector</td>
                    <td><code>strategy/strategy_selector.py</code></td>
                    <td>Dynamic strategy selection by regime</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>SMA Crossover</td>
                    <td><code>strategy/sma_crossover.py</code></td>
                    <td>Short=10, Long=30 crossover</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>EMA Crossover</td>
                    <td><code>strategy/ema_crossover.py</code></td>
                    <td>Fast=12, Slow=26 crossover</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>Momentum Breakout</td>
                    <td><code>strategy/momentum_breakout.py</code></td>
                    <td>Lookback=20, RSI threshold</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>Scalping</td>
                    <td><code>strategy/scalping.py</code></td>
                    <td>Fast EMA=5, Slow=10, RSI=7</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>Mean Reversion</td>
                    <td><code>strategy/mean_reversion.py</code></td>
                    <td>MA=20, BB=2.0, RSI=14</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>Trend Following</td>
                    <td><code>strategy/trend_following.py</code></td>
                    <td>MA(20,50), ADX(14,25)</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>RSI Reversal</td>
                    <td><code>strategy/rsi_reversal.py</code></td>
                    <td>RSI=14, oversold=25, overbought=85</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <!-- Risk -->
                <tr>
                    <td rowspan="4">üõ°Ô∏è Risk</td>
                    <td>Risk Evaluator</td>
                    <td><code>risk/evaluator.py</code></td>
                    <td>Unified risk approval</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>Dynamic SLTP</td>
                    <td><code>risk/dynamic_sltp.py</code></td>
                    <td>ATR-based SL/TP, breakeven, trailing</td>
                    <td class="status-enhanced">‚ö° ENHANCED</td>
                </tr>
                <tr>
                    <td>Liquidity Filter</td>
                    <td><code>filters/liquidity.py</code></td>
                    <td>Spread/volume validation</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>Adaptive Drawdown</td>
                    <td><code>risk/adaptive_drawdown.py</code></td>
                    <td>Drawdown protection</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <!-- Position -->
                <tr>
                    <td rowspan="4">üìç Position</td>
                    <td>Trade Manager</td>
                    <td><code>position/trade_manager.py</code></td>
                    <td>Trade tracking, adoption</td>
                    <td class="status-enhanced">‚ö° ENHANCED</td>
                </tr>
                <tr>
                    <td>Adoption</td>
                    <td><code>position/adoption.py</code></td>
                    <td>External trade adoption</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>Lifecycle</td>
                    <td><code>position/lifecycle.py</code></td>
                    <td>Position state management</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>Position Manager</td>
                    <td><code>position/manager.py</code></td>
                    <td>Position sizing</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <!-- Exit -->
                <tr>
                    <td rowspan="4">üö™ Exit</td>
                    <td>Trailing Stop</td>
                    <td><code>exit/trailing_stop.py</code></td>
                    <td>Profit-locking trailing SL</td>
                    <td class="status-enhanced">‚ö° ENHANCED</td>
                </tr>
                <tr>
                    <td>Time-Based</td>
                    <td><code>exit/time_based.py</code></td>
                    <td>Max hold time exit</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>Profit Target</td>
                    <td><code>exit/profit_target.py</code></td>
                    <td>TP management</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>Adverse Movement</td>
                    <td><code>exit/adverse_movement.py</code></td>
                    <td>Sudden move protection</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <!-- Execution -->
                <tr>
                    <td rowspan="2">‚ö° Execution</td>
                    <td>Engine</td>
                    <td><code>execution/engine.py</code></td>
                    <td>Order execution</td>
                    <td class="status-operational">‚úÖ STABLE</td>
                </tr>
                <tr>
                    <td>MT5 Connector</td>
                    <td><code>connector/mt5_connector.py</code></td>
                    <td>MetaTrader 5 API</td>
                    <td class="status-operational">‚úÖ STABLE</td>
                </tr>
                <!-- Indicators -->
                <tr>
                    <td rowspan="7">üìà Indicators</td>
                    <td>RSI</td>
                    <td><code>indicators/rsi.py</code></td>
                    <td>Relative Strength Index</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>ADX</td>
                    <td><code>indicators/adx.py</code></td>
                    <td>Average Directional Index</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>ATR</td>
                    <td><code>indicators/atr.py</code></td>
                    <td>Average True Range</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>MACD</td>
                    <td><code>indicators/macd.py</code></td>
                    <td>Moving Average Convergence</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>Bollinger</td>
                    <td><code>indicators/bollinger.py</code></td>
                    <td>Bollinger Bands</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>Stochastic</td>
                    <td><code>indicators/stochastic.py</code></td>
                    <td>Stochastic Oscillator</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
                <tr>
                    <td>VWAP</td>
                    <td><code>indicators/vwap.py</code></td>
                    <td>Volume Weighted Avg Price</td>
                    <td class="status-operational">‚úÖ ACTIVE</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Entry Confluence Detail -->
    <div class="section">
        <h2>üÜï Entry Confluence Filter Detail</h2>
        <div class="critical-note">
            <strong>Problem Solved:</strong> System generated revolutionary signals but executed at arbitrary
            price levels. Timing between signal generation and execution caused trades to start stressed.
        </div>
        <div class="mermaid">
            flowchart TB
            subgraph DETECT["Level Detection"]
            L1["Swing S/R"]
            L2["Round Numbers"]
            L3["Prev Session H/L"]
            L4["EMA Levels"]
            end

            subgraph SCORE["Scoring"]
            S1["Level: 40%"]
            S2["Momentum: 25%"]
            S3["Timing: 20%"]
            S4["Structure: 15%"]
            end

            subgraph QUALITY["Classification"]
            Q1["PREMIUM ‚â•85"]
            Q2["GOOD ‚â•70"]
            Q3["MARGINAL ‚â•50"]
            Q4["POOR ‚â•30"]
            Q5["REJECT &lt;30"]
            end

            DETECT --> SCORE --> QUALITY

            Q1 -->|mult=1.0| EXEC["Execute"]
            Q2 -->|mult=0.85| EXEC
            Q3 -->|mult=0.6| EXEC
            Q4 --> WAIT["Wait/Queue"]
            Q5 --> SKIP["Skip"]

            style Q1 fill:#27ae60
            style Q5 fill:#e74c3c
        </div>
    </div>

    <!-- Config Reference -->
    <div class="section">
        <h2>‚öôÔ∏è Configuration Reference</h2>
        <div class="flow-description">
            <h3>Entry Confluence Config:</h3>
            <pre><code>{
  "entry_confluence": {
    "min_score_to_enter": 50,
    "min_score_for_full_size": 75,
    "enable_wait_mode": true,
    "max_wait_bars": 10,
    "level_weight": 0.40,
    "momentum_weight": 0.25,
    "timing_weight": 0.20,
    "structure_weight": 0.15
  }
}</code></pre>
        </div>
    </div>

    <!-- Recent Changes -->
    <div class="section">
        <h2>üìù Recent Updates (January 2026)</h2>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Component</th>
                    <th>Change</th>
                    <th>Impact</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>01-09</td>
                    <td>Dynamic SLTP</td>
                    <td>Fixed trailing stop + TP tracking</td>
                    <td class="status-operational">‚úÖ Working</td>
                </tr>
                <tr>
                    <td>01-09</td>
                    <td>Trade Adoption</td>
                    <td>Fixed external trade adoption flow</td>
                    <td class="status-operational">‚úÖ Working</td>
                </tr>
                <tr>
                    <td>01-09</td>
                    <td>Strategies</td>
                    <td>Added continuation mode, symbol fix</td>
                    <td class="status-operational">‚úÖ Enhanced</td>
                </tr>
                <tr>
                    <td>01-08</td>
                    <td>Cognition</td>
                    <td>Added Phase 2 analysis modules</td>
                    <td class="status-new">üÜï New</td>
                </tr>
                <tr>
                    <td>01-08</td>
                    <td>Entry Confluence</td>
                    <td>Relaxed thresholds, better S/R</td>
                    <td class="status-enhanced">‚ö° Tuned</td>
                </tr>
                <tr>
                    <td>01-08</td>
                    <td>Liquidity Filter</td>
                    <td>Added spread/volume filtering</td>
                    <td class="status-new">üÜï New</td>
                </tr>
                <tr>
                    <td>01-07</td>
                    <td>Signal Generation</td>
                    <td>Fixed UNKNOWN symbol issue</td>
                    <td class="status-operational">‚úÖ Fixed</td>
                </tr>
                <tr>
                    <td>01-07</td>
                    <td>Database</td>
                    <td>Fixed connection pooling, locking</td>
                    <td class="status-operational">‚úÖ Fixed</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Known Issues & Monitoring -->
    <div class="section">
        <h2>‚ö†Ô∏è Monitoring Points</h2>
        <div class="critical-note">
            <strong>Active Monitoring Required:</strong>
            <ul>
                <li><strong>Dynamic SLTP:</strong> Verify trailing stop actually moves SL as price moves in profit
                    direction</li>
                <li><strong>Signal Generation:</strong> Ensure strategies produce signals (not just "NO SIGNAL")</li>
                <li><strong>Trade Adoption:</strong> External trades should get SL/TP within first loop cycle</li>
                <li><strong>Entry Confluence:</strong> Should not reject too many good signals (check score
                    distribution)</li>
            </ul>
        </div>

        <div class="new-feature">
            <strong>Health Indicators (check in logs):</strong>
            <ul>
                <li>‚úÖ "SLTP update:" with actual values means dynamic management working</li>
                <li>‚úÖ "Trailing stop activated" means position is being protected</li>
                <li>‚úÖ "Signal generated:" confirms strategy is producing signals</li>
                <li>‚úÖ "Adopted X external trade(s)" confirms adoption working</li>
                <li>‚ùå "No adjustment needed" every loop may indicate stale position</li>
            </ul>
        </div>
    </div>

    <!-- Configuration Quick Reference -->
    <div class="section">
        <h2>‚öôÔ∏è Configuration Quick Reference</h2>
        <div class="flow-description">
            <h3>config.json Key Settings:</h3>
            <pre><code>{
  "symbol": "BTCUSD#",              // Trading symbol
  "timeframe": "M5",                // 5-minute bars
  "mode": "live",                   // live or dry-run
  
  "strategy_selector": {
    "enabled_strategies": ["sma_crossover", "ema_crossover", "momentum_breakout",
                           "scalping", "mean_reversion", "trend_following", "rsi_reversal"]
  },
  
  "risk": {
    "max_positions": 3,             // Per symbol
    "max_risk_per_trade": 0.02,     // 2% risk
    "min_balance_threshold": 10.0
  },
  
  "dynamic_sltp": {
    "base_sl_atr": 2.0,
    "base_tp_atr": 4.0,
    "breakeven_pips": 10,
    "trailing_trigger_pips": 20,
    "trailing_lock_pct": 0.5
  },
  
  "entry_confluence": {
    "enabled": true,
    "min_score_to_enter": 50,
    "min_score_for_full_size": 75
  },
  
  "adoption_policy": {
    "enabled": true,
    "min_trade_age_seconds": 0,
    "apply_sltp_on_adopt": true
  }
}</code></pre>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#9b59b6',
                primaryTextColor: '#fff',
                lineColor: '#8b949e',
                secondaryColor: '#21262d'
            }
        });
    </script>
    <!-- End-to-End Logic Flow with Heat Map -->
    <div class="section">
        <h2>üî• Execution Flow Heat Map</h2>
        <div class="flow-description">
            <strong>Channel Heat Legend:</strong> Color intensity = execution frequency per loop cycle<br>
            üî¥ <strong>HOT (every loop)</strong> ‚Äî Critical path, high throughput<br>
            üü° <strong>WARM (frequent)</strong> ‚Äî Active but conditional<br>
            üîµ <strong>COOL (occasional)</strong> ‚Äî Event-driven, low frequency
        </div>
        <div class="mermaid">
            flowchart TB
            subgraph LOOP["üîÑ MAIN LOOP (every 15s)"]
            L1["fetch_market_data()"] --> L2["calculate_indicators()"]
            L2 --> L3["generate_signal()"]
            L3 --> L4["scan_and_adopt()"]
            L4 --> L5["manage_positions()"]
            L5 --> L6["apply_dynamic_sltp()"]
            end

            subgraph SIGNAL["üì° SIGNAL GENERATION"]
            S1["regime_classifier"] --> S2["strategy_selector"]
            S2 --> S3["selected_strategy.generate()"]
            S3 --> S4["entry_confluence.analyze()"]
            end

            subgraph EXEC["‚ö° EXECUTION PATH"]
            E1["risk_evaluator.approve()"]
            E2["execution_engine.execute()"]
            E3["mt5_connector.place_order()"]
            E4["trade_manager.register()"]
            end

            subgraph SLTP["üõ°Ô∏è SLTP MANAGEMENT"]
            D1["calculate_initial_sltp()"]
            D2["check_breakeven_trigger()"]
            D3["update_trailing_stop()"]
            D4["modify_position()"]
            end

            subgraph EXIT["üö™ EXIT CHECK"]
            X1["trailing_stop.should_exit()"]
            X2["profit_target.should_exit()"]
            X3["adverse_movement.should_exit()"]
            X4["exit_coordinator.evaluate()"]
            end

            %% Main flow connections
            L3 --> SIGNAL
            S4 -->|"GOOD/PREMIUM"| E1
            S4 -->|"MARGINAL"| E1
            S4 -->|"POOR/REJECT"| SKIP["‚è∏Ô∏è Skip/Wait"]
            E1 -->|"approved"| E2 --> E3 --> E4
            E1 -->|"rejected"| SKIP2["‚ùå Risk Blocked"]

            L4 --> ADOPT["adoption.scan()"]
            ADOPT -->|"found"| D1

            L6 --> D2
            D2 -->|"in profit"| D3 --> D4
            D2 -->|"not triggered"| HOLD["Hold Current"]

            L5 --> EXIT
            X4 -->|"exit signal"| CLOSE["Close Position"]

            %% Heat classes - based on actual execution frequency
            classDef hot fill:#e74c3c,stroke:#c0392b,color:#fff,stroke-width:3px
            classDef warm fill:#f39c12,stroke:#d68910,color:#000,stroke-width:2px
            classDef cool fill:#3498db,stroke:#2980b9,color:#fff,stroke-width:1px
            classDef critical fill:#9b59b6,stroke:#8e44ad,color:#fff,stroke-width:3px

            %% Apply heat based on execution frequency
            class L1,L2,L3,L4,L5,L6 hot
            class S1,S2,S3,S4 hot
            class D2 warm
            class E1 warm
            class X1,X2,X3,X4 warm
            class E2,E3,E4 cool
            class D1,D3,D4 cool
            class ADOPT cool
            class CLOSE,SKIP,SKIP2,HOLD cool
        </div>

        <h3>üéØ Bottleneck Analysis</h3>
        <table>
            <thead>
                <tr>
                    <th>Path</th>
                    <th>Frequency</th>
                    <th>Bottleneck Risk</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Loop ‚Üí Signal Gen ‚Üí Strategy</td>
                    <td>üî¥ Every loop</td>
                    <td>LOW</td>
                    <td>Fast calculation, in-memory</td>
                </tr>
                <tr>
                    <td>Signal ‚Üí Entry Confluence</td>
                    <td>üî¥ Every signal</td>
                    <td>MEDIUM</td>
                    <td>S/R calculation can be slow with large lookback</td>
                </tr>
                <tr>
                    <td>Risk ‚Üí Execution ‚Üí MT5</td>
                    <td>üîµ On signal</td>
                    <td>HIGH</td>
                    <td>MT5 API latency, network dependent</td>
                </tr>
                <tr>
                    <td>SLTP Check ‚Üí Modify</td>
                    <td>üü° Profitable positions</td>
                    <td>MEDIUM</td>
                    <td>MT5 modify_position can timeout</td>
                </tr>
                <tr>
                    <td>Exit Strategies ‚Üí Close</td>
                    <td>üîµ Exit condition</td>
                    <td>LOW</td>
                    <td>Simple checks, fast evaluation</td>
                </tr>
                <tr>
                    <td>Adoption ‚Üí Initial SLTP</td>
                    <td>üîµ New external trades</td>
                    <td>MEDIUM</td>
                    <td>Requires MT5 modify call</td>
                </tr>
            </tbody>
        </table>

        <h3>üîó Race Condition Watch Points</h3>
        <div class="critical-note">
            <ul>
                <li><strong>Dynamic SLTP vs Trailing Stop:</strong> Both can try to modify SL simultaneously.
                    Resolution: trailing_stop only adjusts in-memory tracking, dynamic_sltp does actual MT5
                    modifications.</li>
                <li><strong>Adoption vs Signal Execution:</strong> A trade placed by signal may be re-adopted.
                    Resolution: check magic_number to identify Cthulu-placed trades.</li>
                <li><strong>Database Locking:</strong> Multiple writers (trade_manager, metrics). Resolution: WAL mode
                    enabled, connection pooling.</li>
            </ul>
        </div>
    </div>

    <!-- Trade Lifecycle Flow -->
    <div class="section">
        <h2>üîÑ Trade Lifecycle ‚Äî Complete Flow</h2>
        <div class="flow-description">
            <strong>Trade states:</strong> External Trade ‚Üí Adoption ‚Üí SLTP Applied ‚Üí Dynamic Management ‚Üí Exit
        </div>
        <div class="mermaid">
            flowchart TB
            subgraph ORIGIN["Trade Origin"]
            EXT["External Trade\n(Manual/MT5)"]
            INT["Internal Signal\n(Strategy)"]
            end

            subgraph ADOPT["Trade Adoption"]
            SCAN["scan_for_external_trades()"]
            CHECK["Check magic_number"]
            ADOPT_T["adopt_trade()"]
            end

            subgraph MANAGE["Position Management"]
            SLTP["Apply Initial SL/TP\n(ATR-based)"]
            TRACK["Track in trade_manager"]
            DB_REC["Record in Database"]
            end

            subgraph DYNAMIC["Dynamic Management"]
            DYN_CHECK["Check profit/drawdown"]
            BREAK["Breakeven Mode\n(profit > threshold)"]
            TRAIL["Trailing Mode\n(lock profits)"]
            NORMAL["Normal Mode\n(breathing room)"]
            end

            subgraph EXIT_S["Exit Strategies"]
            TRAIL_EXIT["Trailing Stop"]
            TIME_EXIT["Time-Based Exit"]
            PROFIT_EXIT["Profit Target"]
            ADVERSE["Adverse Movement"]
            end

            EXT --> SCAN
            INT --> SLTP
            SCAN --> CHECK
            CHECK -->|Not ours| ADOPT_T
            ADOPT_T --> SLTP
            SLTP --> TRACK
            TRACK --> DB_REC
            DB_REC --> DYN_CHECK
            DYN_CHECK -->|drawdown| NORMAL
            DYN_CHECK -->|small profit| BREAK
            DYN_CHECK -->|good profit| TRAIL
            NORMAL --> EXIT_S
            BREAK --> EXIT_S
            TRAIL --> EXIT_S
            EXIT_S --> CLOSE["Close Position"]

            style ADOPT fill:#00d4ff,stroke:#00a8cc
            style DYNAMIC fill:#f39c12,stroke:#d68910
            style EXIT_S fill:#e74c3c,stroke:#c0392b
        </div>

        <div class="critical-note">
            <strong>Key Points:</strong>
            <ul>
                <li>All trades (internal + external) get SL/TP applied via ATR calculation</li>
                <li>Dynamic SLTP adjusts based on profit state: drawdown ‚Üí breakeven ‚Üí trailing</li>
                <li>Trailing stop only moves SL in profit direction, never against trade</li>
                <li>MT5 freeze levels respected (min distance from current price)</li>
            </ul>
        </div>
    </div>

    <!-- Signal Generation Flow -->
    <div class="section">
        <h2>üì° Signal Generation Pipeline</h2>
        <div class="mermaid">
            flowchart LR
            subgraph DATA["Market Data"]
            OHLCV["OHLCV Bars"]
            TICK["Tick Data"]
            end

            subgraph IND["Indicators"]
            RSI["RSI"]
            ADX["ADX"]
            EMA["EMA 5/10/12/26"]
            SMA["SMA 10/30/50"]
            BB["Bollinger"]
            ATR["ATR"]
            MACD["MACD"]
            end

            subgraph REGIME["Market Regime"]
            TREND_UP["Trending Up"]
            TREND_DOWN["Trending Down"]
            RANGE["Ranging"]
            VOL["Volatile"]
            end

            subgraph STRAT["Strategy Selection"]
            SCORE["Score Each Strategy"]
            SELECT["Select Best for Regime"]
            end

            subgraph SIGNAL["Signal Generation"]
            GEN["generate_signal()"]
            CONF["Entry Confluence\nFilter"]
            FINAL["Final Signal"]
            end

            DATA --> IND
            IND --> REGIME
            REGIME --> STRAT
            STRAT --> SIGNAL
            GEN --> CONF
            CONF -->|PASS| FINAL
            CONF -->|FAIL| REJECT["‚ùå Rejected"]

            style CONF fill:#00d4ff
            style FINAL fill:#27ae60
            style REJECT fill:#e74c3c
        </div>
    </div>

    <!-- Dynamic SLTP Logic -->
    <div class="section">
        <h2>‚ö° Dynamic SL/TP Logic</h2>
        <div class="mermaid">
            flowchart TB
            START["Position Check"] --> PROFIT{"Profit > 0?"}

            PROFIT -->|No| NORMAL["NORMAL Mode\nSL = entry ¬± 2√óATR\nTP = entry ¬± 4√óATR"]
            PROFIT -->|Yes| PROFIT_CHECK{"Profit > breakeven_pips?"}

            PROFIT_CHECK -->|No| NORMAL
            PROFIT_CHECK -->|Yes| BREAK["BREAKEVEN Mode\nSL ‚Üí Entry Price"]

            BREAK --> TRAIL_CHECK{"Profit > trailing_trigger?"}
            TRAIL_CHECK -->|No| BREAK
            TRAIL_CHECK -->|Yes| TRAIL["TRAILING Mode\nSL = price - (lock_pct √ó profit)"]

            TRAIL --> UPDATE["Update SL/TP via MT5"]
            NORMAL --> UPDATE
            BREAK --> UPDATE

            UPDATE --> FREEZE{"Respects freeze level?"}
            FREEZE -->|Yes| APPLY["Apply Changes"]
            FREEZE -->|No| SKIP["Skip Update\n(too close to price)"]

            style NORMAL fill:#3498db
            style BREAK fill:#f39c12
            style TRAIL fill:#27ae60
            style SKIP fill:#95a5a6
        </div>

        <div class="flow-description">
            <h3>SLTP Parameters (from config):</h3>
            <pre><code>{
  "dynamic_sltp": {
    "base_sl_atr": 2.0,           // SL = 2 √ó ATR from entry
    "base_tp_atr": 4.0,           // TP = 4 √ó ATR from entry  
    "breakeven_pips": 10,         // Move to breakeven after 10 pips profit
    "trailing_trigger_pips": 20,  // Start trailing after 20 pips
    "trailing_lock_pct": 0.5      // Lock 50% of profit when trailing
  }
}</code></pre>
        </div>
    </div>

</body>

</html>