┌──────────────────────────────────────────────────────────────────────────────┐
│                        CTHULU ML/RL ARCHITECTURE                             │
└──────────────────────────────────────────────────────────────────────────────┘

                           ┌─────────────────────┐
                           │    MARKET DATA      │
                           │   (MT5/Broker)      │
                           └──────────┬──────────┘
                                      │
                                      ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                         DATA COLLECTION LAYER                                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌──────────────────┐              ┌──────────────────┐                    │
│   │  MLDataCollector │              │  TrainingLogger  │                    │
│   │  (ML_RL/instr.py)│              │  (cognition/)    │                    │
│   └────────┬─────────┘              └────────┬─────────┘                    │
│            │                                  │                              │
│            ▼                                  ▼                              │
│   ┌──────────────────┐              ┌──────────────────┐    ┌────────────┐ │
│   │ ML_RL/data/raw/  │              │cognition/data/raw│    │ cthulu.db  │ │
│   │ 184 files, 805KB │              │ 385 files, 1.4MB │    │  (SQLite)  │ │
│   └──────────────────┘              └──────────────────┘    └────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                         FEATURE ENGINEERING                                  │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                    ┌─────────────────────────────┐                           │
│                    │     FeaturePipeline         │                           │
│                    │  (ML_RL/feature_pipeline.py)│                           │
│                    └─────────────┬───────────────┘                           │
│                                  │                                           │
│          ┌───────────┬───────────┼───────────┬───────────┐                  │
│          ▼           ▼           ▼           ▼           ▼                  │
│    ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐        │
│    │Technical │ │  Price   │ │  Volume  │ │ Multi-TF │ │  Trend   │        │
│    │Indicators│ │ Patterns │ │ Analysis │ │ Features │ │ Strength │        │
│    │RSI,MACD  │ │momentum  │ │          │ │          │ │          │        │
│    │BB,ATR    │ │volatility│ │          │ │          │ │          │        │
│    └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘        │
│                                  │                                           │
│                                  ▼                                           │
│                    ┌─────────────────────────────┐                           │
│                    │   50+ Engineered Features   │                           │
│                    └─────────────────────────────┘                           │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                      │
                  ┌───────────────────┼───────────────────┐
                  ▼                   ▼                   ▼
┌─────────────────────┐ ┌─────────────────────┐ ┌─────────────────────┐
│   PRICE PREDICTOR   │ │   RL POSITION SIZER │ │   TIER OPTIMIZER    │
├─────────────────────┤ ├─────────────────────┤ ├─────────────────────┤
│                     │ │                     │ │                     │
│  Softmax Classifier │ │  Hybrid Agent:      │ │  Bayesian Optimizer │
│                     │ │  • Q-Learning       │ │                     │
│  Outputs:           │ │  • PPO Policy       │ │  Optimizes:         │
│  • UP probability   │ │                     │ │  • scale_factor     │
│  • DOWN probability │ │  Actions:           │ │  • tier_count (1-5) │
│  • SIDEWAYS prob    │ │  • 0.25x to 2.0x    │ │  • profit_targets   │
│                     │ │  • Position mult    │ │                     │
│  Example:           │ │                     │ │  Tiers:             │
│  UP=0.60            │ │  Reward:            │ │  T1: 25% @ 0.5%     │
│  DOWN=0.30          │ │  • PnL-based        │ │  T2: 25% @ 1.0%     │
│  SIDE=0.10          │ │  • Risk-adjusted    │ │  T3: 25% @ 1.5%     │
│                     │ │  • Drawdown penalty │ │  T4: 25% @ 2.0%     │
│                     │ │                     │ │                     │
└─────────┬───────────┘ └─────────┬───────────┘ └─────────┬───────────┘
          │                       │                       │
          └───────────────────────┼───────────────────────┘
                                  ▼
                    ┌─────────────────────────────┐
                    │      TRADING DECISION       │
                    │  • Direction (from PP)      │
                    │  • Size (from RL)           │
                    │  • Exit tiers (from TO)     │
                    └─────────────┬───────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                           LLM ANALYSIS                                       │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                    ┌─────────────────────────────┐                           │
│                    │        LLMAnalyzer          │                           │
│                    │   (ML_RL/llm_analyzer.py)   │                           │
│                    └─────────────┬───────────────┘                           │
│                                  │                                           │
│          ┌───────────────────────┼───────────────────────┐                  │
│          ▼                       ▼                       ▼                  │
│   ┌──────────────┐      ┌──────────────┐      ┌──────────────┐             │
│   │   Market     │      │    Trade     │      │     Risk     │             │
│   │  Narrative   │      │  Rationale   │      │  Assessment  │             │
│   └──────────────┘      └──────────────┘      └──────────────┘             │
│                                                                              │
│   Backend: Local Ollama (qwen2.5:3b / llama3.2:3b)                          │
│   Fallback: Template-based generation                                        │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                              MLOps                                           │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────┐    ┌────────────────┐    ┌────────────────┐            │
│  │ Model Registry │    │ Drift Detector │    │ Auto Retrainer │            │
│  ├────────────────┤    ├────────────────┤    ├────────────────┤            │
│  │• Version track │    │• KS-test       │    │• Trigger on    │            │
│  │• Metadata      │───▶│• Feature drift │───▶│  drift detect  │            │
│  │• Promote/arch  │    │• Alerts        │    │• Auto-train    │            │
│  └────────────────┘    └────────────────┘    └────────────────┘            │
│                                                                              │
│  Storage: ML_RL/models/registry/                                            │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                         STORAGE SUMMARY                                      │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ML_RL/                                                                      │
│  ├── data/                                                                   │
│  │   ├── raw/              184 files    805 KB   Event logs                 │
│  │   ├── training/         469 files    1.7 MB   Training data              │
│  │   ├── tier_optimizer/     1 file       7 KB   Optimizer state            │
│  │   └── metrics/                                Performance logs           │
│  ├── models/                                                                 │
│  │   ├── rl/                                     RL sizer model             │
│  │   └── registry/                               Model registry             │
│  ├── feature_pipeline.py                                                     │
│  ├── rl_position_sizer.py                                                    │
│  ├── llm_analyzer.py                                                         │
│  ├── mlops.py                                                                │
│  └── train_models.py                                                         │
│                                                                              │
│  cognition/                                                                  │
│  ├── data/raw/             385 files    1.4 MB   Decision logs              │
│  ├── price_predictor.py                                                      │
│  ├── tier_optimizer.py                                                       │
│  └── engine.py                                                               │
│                                                                              │
│  TOTAL: ~21 MB                                                               │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                           CLI COMMANDS                                       │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Data Management:                                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  python scripts/data_cli.py status         # Storage summary         │   │
│  │  python scripts/data_cli.py health         # Endpoint health         │   │
│  │  python scripts/data_cli.py cleanup --days 30   # Cleanup old        │   │
│  │  python scripts/data_cli.py export --output ./exports                │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  Training:                                                                   │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  python -m ML_RL.train_models --component all       # Train all      │   │
│  │  python -m ML_RL.train_models --component predictor # Price only     │   │
│  │  python -m ML_RL.train_models --component rl        # RL sizer       │   │
│  │  python -m ML_RL.train_models --component optimizer # Tier opt       │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘