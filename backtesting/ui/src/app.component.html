<div class="min-h-screen flex flex-col font-sans">
  
  <!-- Header -->
  <header class="bg-slate-900 border-b border-slate-800 py-4 px-6 flex justify-between items-center shadow-lg">
    <div class="flex items-center space-x-3">
      <div class="w-10 h-10 bg-emerald-600 rounded flex items-center justify-center text-white text-xl font-bold">
        <i class="fa-solid fa-tentacle"></i>
      </div>
      <div>
        <h1 class="text-xl font-bold text-emerald-400 tracking-wider">CTHULHU</h1>
        <p class="text-xs text-slate-500 uppercase tracking-widest">Backtesting Framework</p>
      </div>
    </div>
    <div class="text-slate-400 text-sm">
      <span class="mr-4"><i class="fa-solid fa-server mr-2"></i>Status: <span class="text-emerald-500">Online</span></span>
      <span>v5.1.0-APEX</span>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
    
    <!-- Left Column: Config -->
    <div class="lg:col-span-3 space-y-6">
      <app-configuration 
        (run)="handleRun($event)"
        (fileLoaded)="onFileLoaded($event)">
      </app-configuration>
      
      <!-- Instructions Panel -->
      <div class="bg-slate-900 border border-slate-700 rounded-lg p-6">
        <h3 class="text-slate-300 font-bold mb-3"><i class="fa-regular fa-circle-question mr-2"></i>Framework Guide</h3>
        <p class="text-slate-400 text-sm leading-relaxed mb-2">
          1. <strong>Execution</strong>: Select Data Source and Speed Mode. (FAST recommended).
        </p>
        <p class="text-slate-400 text-sm leading-relaxed mb-2">
          2. <strong>Ensemble</strong>: Enable to use Adaptive Weighting across multiple strategies.
        </p>
        <p class="text-slate-400 text-sm leading-relaxed">
          3. <strong>ML</strong>: Adjust Signal Selection temperature for exploration vs exploitation balance.
        </p>
      </div>
    </div>

    <!-- Right Column: Visualization & Results -->
    <div class="lg:col-span-9 space-y-6">
      
      <!-- Optimization Status -->
      @if (optResult()) {
        <div class="bg-purple-900/30 border border-purple-500/50 rounded-lg p-4 flex items-center justify-between animate-fade-in">
           <div>
             <h3 class="text-purple-400 font-bold uppercase text-sm tracking-wider mb-1">Optimization Complete</h3>
             <p class="text-slate-300 text-sm">
               Tested <span class="font-mono font-bold text-white">{{ optResult()!.iterations }}</span> combinations. 
               Best Profit Factor: <span class="font-mono font-bold text-emerald-400">{{ optResult()!.bestProfitFactor.toFixed(2) }}</span>
             </p>
           </div>
           <div class="text-right">
             <div class="text-slate-400 text-xs uppercase">Optimal Parameters</div>
             <div class="text-white font-mono font-bold text-lg">
               Fast: {{ optResult()!.bestFastMa }} / Slow: {{ optResult()!.bestSlowMa }}
             </div>
           </div>
        </div>
      }

      @if (results()) {
        <!-- Chart Section -->
        <app-chart [data]="results()"></app-chart>
        
        <!-- Metrics Section -->
        <app-metrics [data]="results()!.metrics"></app-metrics>

        <!-- AI Analysis Section -->
        <div class="bg-slate-900 border border-slate-700 rounded-lg p-6 shadow-xl">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-purple-400 flex items-center">
              <i class="fa-solid fa-brain mr-2"></i> Cthulhu AI Analysis
            </h2>
            <button (click)="analyze()" [disabled]="isAnalyzing()" 
              class="bg-purple-600 hover:bg-purple-500 disabled:bg-slate-700 disabled:cursor-not-allowed text-white px-4 py-2 rounded text-sm transition-colors shadow-lg">
              @if (isAnalyzing()) {
                <i class="fa-solid fa-spinner fa-spin mr-2"></i> Analyzing...
              } @else {
                Generate Report
              }
            </button>
          </div>
          
          @if (aiAnalysis()) {
            <!-- Rich HTML Output -->
            <div class="animate-fade-in" [innerHTML]="aiAnalysis()"></div>
          } @else {
            <div class="text-slate-500 italic text-sm p-4 bg-slate-950/50 rounded border border-slate-800 border-dashed text-center">
              Run a backtest and click "Generate Report" to receive an institutional-grade performance assessment.
            </div>
          }
        </div>

        <!-- Trade Log Table -->
        <div class="bg-slate-900 border border-slate-700 rounded-lg overflow-hidden">
          <div class="px-6 py-4 border-b border-slate-800">
            <h3 class="font-bold text-slate-300">Trade Log (Last 10)</h3>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-slate-400">
              <thead class="text-xs text-slate-500 uppercase bg-slate-950">
                <tr>
                  <th class="px-6 py-3">Entry Time</th>
                  <th class="px-6 py-3">Type</th>
                  <th class="px-6 py-3">Entry Price</th>
                  <th class="px-6 py-3">Exit Price</th>
                  <th class="px-6 py-3 text-right">PnL</th>
                </tr>
              </thead>
              <tbody>
                @for (trade of lastTrades(); track trade.entryTime) {
                  <tr class="bg-slate-900 border-b border-slate-800 hover:bg-slate-800">
                    <td class="px-6 py-4">{{ formatDate(trade.entryTime) }}</td>
                    <td class="px-6 py-4 text-blue-400 font-bold">LONG</td>
                    <td class="px-6 py-4">{{ trade.entryPrice.toFixed(2) }}</td>
                    <td class="px-6 py-4">{{ trade.exitPrice.toFixed(2) }}</td>
                    <td class="px-6 py-4 text-right font-mono font-bold"
                        [class.text-emerald-400]="trade.pnl > 0" 
                        [class.text-red-400]="trade.pnl < 0">
                      {{ trade.pnl.toFixed(2) }}
                    </td>
                  </tr>
                }
                @if (lastTrades().length === 0) {
                  <tr>
                    <td colspan="5" class="text-center py-8 text-slate-600">No trades executed in this period.</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>

      } @else {
        <!-- Empty State -->
        <div class="h-96 flex flex-col items-center justify-center bg-slate-900/50 border-2 border-dashed border-slate-700 rounded-lg">
          <div class="text-slate-600 text-6xl mb-4">
            <i class="fa-solid fa-chart-line"></i>
          </div>
          <p class="text-slate-400 text-lg">No backtest data available</p>
          <p class="text-slate-600 text-sm mt-2">Upload a CSV or Run Simulation to see results.</p>
        </div>
      }

    </div>
  </main>
</div>